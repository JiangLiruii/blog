---
layout:       post
title:        "HTTP/2"
subtitle:     "改革开放, 走进新时代"
date:         2018-11-26 12:00:00
author:       "Lorry"
header-mask:  0.3
header-img:   '/img/http2.png'
catalog:      true
multilingual: false
tags:
    - web
---
# http2是很早就想写的内容了, 这是 http/1.1以来跨版本的升级, 解决了以前很多问题, 可以大幅度的提高 http 的响应速度, 充分利用每一个 tcp 连接. 头图就是来自一个非常出名的 http/2的 [demo](https://http2.akamai.com/demo), 感兴趣的可以点进去看一下, 会有更直观的了解.

# 网络请求最主要的影响因素有两个 1 带宽 2 延迟

## 带宽

### 现在动辄百兆光纤入户, 带宽已经不再是很大的因素, 但是在网络刚起步的时候, 还是拨号上网, 带宽十分的珍贵, 所以那时候的网页不会像现在这样花里胡哨, 朴素很多.

这是2018年的雅虎主页: 

![](/img/yahoo_2018.png)

这是2000年的雅虎主页:

![](/img/yahoo_2000.png)

BTW, 推荐一个查看历史网页快照的网站, 需科学上网: https://web.archive.org.

## 延迟

### 延迟是 http 的天然缺陷, 从出生之初就有, 主要原因有以下几点:

- 查找 ip 需要 DNS 解析, 耗时.
- 找到 ip 后, 建立 TCP 的时间长, 需要三次握手以确保可靠性, 俗称慢启动
- 一条 TCP 连接无法复用, 每次请求都需要重新去建立 TCP
- 浏览器并发请求的数量有限, 大多数对同域下的请求数不超过4个, 所以一旦有请求被阻塞, 就非常耽误加载时间.HOL(head-of-line) blocking--线头阻塞

线头阻塞: 源自[维基百科](https://en.wikipedia.org/wiki/Head-of-line_blocking)

![](/img/HOL_blocking.png)

### 在 Http/2以前有以下的解决方案:

- 设置请求头 Connection: Keep-Alive, 可定义是否一定时间内复用连接, 这个时间是由服务器决定, 且在现在移动 App 的使用场景下都是分散请求, 间隔时间不固定, 使用该方法有一定的局限性.
- 建立基于 tcp 的长连接, 比如socket, 但实现难度比较高
- long-polling, 极端情况下导致多个连接被挂起, 服务器压力增大
- streaming, 在 response 中增加`Transfer Encoding:chuncked`来告诉客户端后续还有数据. 问题在于有些业务数据不能按照请求进行分割, 或者分割成本高
- websocket, 和传统的 tcp socket 类似, 提供双向的数据流, 比传统的更简单, 但技术较新, 不是所有浏览器都支持. 具体的分析可以看前文[Websockt](./2018-04-03-WebSocket.md)
- pipelining 解决请求阻塞.(图片源自[维基百科](https://en.wikipedia.org/wiki/HTTP_pipelining)), 请求不需要等待服务器响应, 可以全部发过去, 但是对请求方式限制(GET, HEAD), 且请求间相互不能依赖, 在2018年, 这个功能因为代理服务器和线头阻塞被默认关闭了.

![](/img/HTTP_pipelining.svg)

- SPDY, 支持对请求进行优先级排序和多路复用, 只需求一个 TCP 即可传输多个请求, 广泛使用了 TLS 加密, 传输内容也以 gzip 或 DEFLATE 格式压缩, 还可以主动推送内容.这里只介绍多路复用的特性.
![](/img/spdy.png)



